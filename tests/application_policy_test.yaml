
suite: Test argo application installation policy
templates:
  - templates/policies/application-policies.yaml
release:
  name: release-test
tests:

  - it: Should render the clusterselector when using acmlabels
    values:
      - ./clusterselector_values.yaml
    asserts:
      - documentSelector:
          path: metadata.name
          value: group-one-placement
        equal:
          path: spec.clusterSelector.matchLabels.clusterGroup
          value: group-one

  - it: Should render the clusterselector when using acmlabels with an override
    values:
      - ./clusterselector_values.yaml
    set:
      clusterGroup:
        managedClusterGroups:
          exampleRegion:
            name: group-two
            acmlabels:
              - name: clusterGroup
                value: group-two
    asserts:
      - documentSelector:
          path: metadata.name
          value: group-two-placement
        equal:
          path: spec.clusterSelector.matchLabels.clusterGroup
          value: group-two

  - it: Should render the clusterselector when using json
    values:
      - ./clusterselector_values.yaml
    set:
      clusterGroup:
        managedClusterGroups:
          exampleRegion:
            clusterSelector:
              foo: bar
    asserts:
      - documentSelector:
          path: metadata.name
          value: group-one-placement
        equal:
          path: spec.clusterSelector
          value: {foo: bar}

  - it: Should render the clusterselector when acmlabels is empty
    values:
      - ./clusterselector_values.yaml
    set:
      clusterGroup:
        managedClusterGroups:
          exampleRegion:
            name: group-two
            acmlabels: {}
    asserts:
      - documentSelector:
          path: metadata.name
          value: group-two-placement
        equal:
          path: spec.clusterSelector.matchLabels.clusterGroup
          value: group-two

  - it: Should render the clusterselector when acmlabels is unset
    values:
      - ./clusterselector_values.yaml
    set:
      clusterGroup:
        managedClusterGroups:
          exampleRegion:
            name: group-two
            acmlabels: nil
    asserts:
      - documentSelector:
          path: metadata.name
          value: group-two-placement
        equal:
          path: spec.clusterSelector.matchLabels.clusterGroup
          value: group-two

  # Tests for clusterGroupGitRepoUrl and clusterGroupChartGitRevision
  - it: Should use chart clustergroup when clusterGroupGitRepoUrl is not set
    values:
      - ./clusterselector_values.yaml
    set:
      global:
        multiSourceSupport: true
        multiSourceRepoUrl: "https://charts.example.com"
        multiSourceTargetRevision: "0.1.0"
    asserts:
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].chart
          value: clustergroup
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].repoURL
          value: "https://charts.example.com"
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].targetRevision
          value: "0.1.0"
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        isNull:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].path

  - it: Should use path when clusterGroupGitRepoUrl is set
    values:
      - ./clusterselector_values.yaml
    set:
      global:
        multiSourceSupport: true
        multiSourceRepoUrl: "https://charts.example.com"
        multiSourceTargetRevision: "0.1.0"
      main:
        multiSourceConfig:
          clusterGroupGitRepoUrl: "https://github.com/example/clustergroup-chart"
          clusterGroupChartGitRevision: "feature-branch"
    asserts:
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].path
          value: "."
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].repoURL
          value: "https://github.com/example/clustergroup-chart"
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].targetRevision
          value: "feature-branch"
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        isNull:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].chart

  - it: Should use clusterGroupGitRepoUrl with fallback to multiSourceTargetRevision when only clusterGroupGitRepoUrl is set
    values:
      - ./clusterselector_values.yaml
    set:
      global:
        multiSourceSupport: true
        multiSourceRepoUrl: "https://charts.example.com"
        multiSourceTargetRevision: "0.1.0"
      main:
        multiSourceConfig:
          clusterGroupGitRepoUrl: "https://github.com/example/clustergroup-chart"
    asserts:
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].path
          value: "."
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].repoURL
          value: "https://github.com/example/clustergroup-chart"
      - documentSelector:
          path: metadata.name
          value: group-one-clustergroup-policy
        equal:
          path: spec.policy-templates[0].objectDefinition.spec.object-templates[0].objectDefinition.spec.sources[1].targetRevision
          value: "0.1.0"

