suite: Test Hub Cluster Detection Logic - Private Repo Policies
templates:
  - templates/policies/private-repo-policies.yaml
release:
  name: release-test
tests:
  # Test 1: Hub cluster when localClusterDomain equals hubClusterDomain (includes private hub policy)
  - it: should render private hub policy when localClusterDomain equals hubClusterDomain
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        hubClusterDomain: "apps.hub.example.com"
        localClusterDomain: "apps.hub.example.com"
        privateRepo: true
        pattern: "test-pattern"
      clusterGroup:
        isHubCluster: null  # Explicitly unset to enable domain-based detection
        managedClusterGroups:
          testRegion:
            name: region-one
            labels:
            - name: clusterGroup
              value: region-one
    asserts:
      - documentSelector:
          path: metadata.name
          value: vp-private-hub-policy
        isKind:
          of: Policy
      - hasDocuments:
          count: 6

  # Test 2: Not hub cluster when localClusterDomain differs from hubClusterDomain (no private hub policy)
  - it: should not render private hub policy when localClusterDomain differs from hubClusterDomain
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        hubClusterDomain: "apps.hub.example.com"
        localClusterDomain: "apps.spoke.example.com"
        privateRepo: true
        pattern: "test-pattern"
      clusterGroup:
        isHubCluster: null  # Explicitly unset to enable domain-based detection
        managedClusterGroups:
          testRegion:
            name: region-one
            labels:
            - name: clusterGroup
              value: region-one
    asserts:
      # Should have the managed cluster policies but not the hub policy
      - documentSelector:
          path: metadata.name
          value: private-region-one-policy
        isKind:
          of: Policy
      - hasDocuments:
          count: 3

  # Test 3: Fallback to isHubCluster when domains are not set (true)
  - it: should render private hub policy when fallback to isHubCluster true
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        # No domain configuration provided
        privateRepo: true
        pattern: "test-pattern"
      clusterGroup:
        isHubCluster: true
        managedClusterGroups:
          testRegion:
            name: region-one
            labels:
            - name: clusterGroup
              value: region-one
    asserts:
      - documentSelector:
          path: metadata.name
          value: vp-private-hub-policy
        isKind:
          of: Policy
      - hasDocuments:
          count: 6

  # Test 4: Fallback to isHubCluster false when no domain configuration is provided
  - it: should not render private hub policy when fallback to isHubCluster false
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        # No domain configuration provided
        privateRepo: true
        pattern: "test-pattern"
      clusterGroup:
        isHubCluster: false
        managedClusterGroups:
          testRegion:
            name: region-one
            labels:
            - name: clusterGroup
              value: region-one
    asserts:
      # Should have the managed cluster policies but not the hub policy
      - documentSelector:
          path: metadata.name
          value: private-region-one-policy
        isKind:
          of: Policy
      - hasDocuments:
          count: 3

  # Test 5: No policies when privateRepo is false
  - it: should not render any private repo policies when privateRepo is false
    set:
      global:
        repoURL: https://github.com/validatedpatterns/multicloud-gitops
        hubClusterDomain: "apps.hub.example.com"
        localClusterDomain: "apps.hub.example.com"
        privateRepo: false
        pattern: "test-pattern"
      clusterGroup:
        isHubCluster: true
        managedClusterGroups:
          testRegion:
            name: region-one
            labels:
            - name: clusterGroup
              value: region-one
    asserts:
      - hasDocuments:
          count: 0